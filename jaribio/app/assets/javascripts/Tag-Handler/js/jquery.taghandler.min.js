(function($){var methods={getSerializedTags:function(){var currentTags=[];$(this).find("li.tagItem").each(function(i,e){currentTags.push($(e).text())});return currentTags.join(',')},getTags:function(){var currentTags=[];$(this).find("li.tagItem").each(function(i,e){currentTags.push($(e).text())});return currentTags}};$.fn.tagHandler=function(options){if(typeof(options)=='object'||typeof(options)=='undefined'){var opts=$.extend({},$.fn.tagHandler.defaults,options);debug($(this),opts);return this.each(function(){if(!$(this).is('ul')){return true}var tagContainer=this;var tagContainerObject=$(tagContainer);if(!tagContainer.id){var d=new Date();tagContainer.id=d.getTime()}tagContainerObject.wrap('<div class="'+opts.className+'" />');tagContainerObject.addClass(opts.className+"Container");if(opts.allowEdit){tagContainerObject.html('<li class="tagInput"><input class="tagInputField" type="text" /></li>')}var inputField=tagContainerObject.find(".tagInputField");var tags=[];tags.availableTags=[];tags.originalTags=[];tags.assignedTags=[];if(opts.updateURL!==''){if(!opts.autoUpdate){$("<div />").attr({id:tagContainer.id+"_save",title:"Save Tags"}).addClass("tagUpdate").click(function(){saveTags(tags,opts,tagContainer.id)}).appendTo(tagContainerObject.parent())}$("<div />").attr({id:tagContainer.id+"_loader",title:"Saving Tags"}).addClass("tagLoader").appendTo(tagContainerObject.parent())}if(opts.getURL!==''&&opts.initLoad){$.ajax({url:opts.getURL,cache:false,data:opts.getData,dataType:'json',success:function(data,text,xhr){if(data.availableTags.length){tags.availableTags=data.availableTags.slice();tags.originalTags=tags.availableTags.slice()}if(opts.sortTags){tags=sortTags(tags)}if(data.assignedTags.length){tags.assignedTags=data.assignedTags.slice();if(opts.sortTags){tags=sortTags(tags)}tags=addAssignedTags(opts,tags,inputField,tagContainer)}if(opts.autocomplete&&typeof($.fn.autocomplete)=='function'&&opts.allowEdit){$(inputField).autocomplete("option","source",tags.availableTags)}},error:function(xhr,text,error){debug(xhr,text,error);alert(opts.msgError)}})}else if(opts.getURL!==''){tags.assignedTags=opts.assignedTags.slice();if(opts.sortTags){tags=sortTags(tags)}tags=addAssignedTags(opts,tags,inputField,tagContainer)}else{if(opts.availableTags.length){tags.availableTags=opts.availableTags.slice();tags.originalTags=tags.availableTags.slice()}if(opts.sortTags){tags=sortTags(tags)}if(opts.assignedTags.length){tags.assignedTags=opts.assignedTags.slice();if(opts.sortTags){tags=sortTags(tags)}tags=addAssignedTags(opts,tags,inputField,tagContainer)}if(opts.autocomplete&&typeof($.fn.autocomplete)=='function'&&opts.allowEdit&&opts.initLoad){$(inputField).autocomplete("option","source",tags.availableTags)}}if(opts.allowEdit){tagContainerObject.delegate("li.tagItem","click",function(){if(typeof(opts.onDelete)=="function"){opts.onDelete.call(this,$.trim($(this).text()))}tags=removeTag($(this),tags,opts.sortTags);if(opts.updateURL!==''&&opts.autoUpdate){saveTags(tags,opts,tagContainer.id)}if(opts.autocomplete&&typeof($.fn.autocomplete)=='function'&&opts.initLoad){$(inputField).autocomplete("option","source",tags.availableTags)}});$(inputField).keypress(function(e){if(e.which===13||e.which===44||e.which===opts.delimiter.charCodeAt(0)){e.preventDefault();if($(this).val()!==""&&!checkTag($.trim($(this).val()),tags.assignedTags)){if(!opts.allowAdd&&!checkTag($.trim($(this).val()),tags.availableTags)){alert(opts.msgNoNewTag);return}if(opts.maxTags>0&&tags.assignedTags.length>=opts.maxTags){alert('Maximum tags allowed: '+opts.maxTags)}else{var newTag=$.trim($(this).val());tags=addTag(this,newTag,tags,opts.sortTags);if(opts.updateURL!==''&&opts.autoUpdate){saveTags(tags,opts,tagContainer.id)}if(opts.autocomplete&&typeof($.fn.autocomplete)=='function'&&opts.initLoad){$(inputField).autocomplete("option","source",tags.availableTags)}if(typeof(opts.onAdd)=="function"){opts.onAdd.call(this,newTag)}}$(this).val("");$(this).focus()}}});$(inputField).keydown(function(e){if(e.which===8&&$(this).val()===""){if(typeof(opts.onDelete)=="function"){opts.onDelete.call(this,$.trim($(this).val()))}tags=removeTag(tagContainerObject.find(".tagItem:last"),tags,opts.sortTags);if(opts.updateURL!==''&&opts.autoUpdate){saveTags(tags,opts,tagContainer.id)}if(opts.autocomplete&&typeof($.fn.autocomplete)=='function'&&opts.initLoad){$(inputField).autocomplete("option","source",tags.availableTags)}$(this).focus()}});if(opts.autocomplete&&typeof($.fn.autocomplete)=='function'&&opts.initLoad){$(inputField).autocomplete({source:tags.availableTags,select:function(event,ui){if(!checkTag($.trim(ui.item.value),tags.assignedTags)){if(opts.maxTags>0&&tags.assignedTags.length>=opts.maxTags){alert('Maximum tags allowed: '+opts.maxTags)}else{var newTag=$.trim(ui.item.value);tags=addTag(this,newTag,tags,opts.sortTags);if(opts.updateURL!==''&&opts.autoUpdate){saveTags(tags,opts,tagContainer.id)}$(inputField).autocomplete("option","source",tags.availableTags);if(typeof(opts.onAdd)=="function"){opts.onAdd.call(this,newTag)}}$(this).focus()}$(this).val("");return false},minLength:opts.minChars})}else if(opts.autocomplete&&typeof($.fn.autocomplete)=='function'){$(inputField).autocomplete({source:function(request,response){opts.getData[opts.queryname]=request.term;lastXhr=$.getJSON(opts.getURL,opts.getData,function(data,status,xhr){response(data.availableTags)})},select:function(event,ui){if(!checkTag($.trim(ui.item.value),tags.assignedTags)){if(opts.maxTags>0&&tags.assignedTags.length>=opts.maxTags){alert('Maximum tags allowed: '+opts.maxTags)}else{var newTag=$.trim(ui.item.value);tags=addTag(this,$.trim(ui.item.value),tags,opts.sortTags);if(opts.updateURL!==''&&opts.autoUpdate){saveTags(tags,opts,tagContainer.id)}if(typeof(opts.onAdd)=="function"){opts.onAdd.call(this,newTag)}}$(this).focus()}$(this).val('');return false},minLength:opts.minChars})}$(inputField).focus(function(){if($(inputField).val()===''&&opts.autocomplete&&typeof($.fn.autocomplete)=='function'&&opts.initLoad){$(inputField).autocomplete("search","")}});tagContainerObject.click(function(){$(inputField).focus()})}this.getTags=function(){return tags.assignedTags};return 1})}else if(typeof(options)=="string"&&methods[options]){return methods[options].apply(this,Array.prototype.slice.call(arguments,1))}};$.fn.tagHandler.defaults={allowEdit:true,allowAdd:true,assignedTags:[],autocomplete:false,autoUpdate:false,availableTags:[],className:'tagHandler',debug:false,delimiter:'',getData:{},getURL:'',initLoad:true,maxTags:0,minChars:0,msgNoNewTag:"You don't have permission to create a new tag.",msgError:"There was an error getting the tag list.",onAdd:{},onDelete:{},queryname:'q',sortTags:true,updateData:{},updateURL:''};function checkTag(value,tags){var check=false;$(tags).each(function(i,e){if(e===value){check=true;return false}});return check}function removeTagFromList(value,tags){$(tags).each(function(i,e){if(e===value){tags.splice(i,1)}});return tags}function addTag(tagField,value,tags,sort){tags.assignedTags.push(value);tags.availableTags=removeTagFromList(value,tags.availableTags);$("<li />").addClass("tagItem").html(value).insertBefore($(tagField).parent());if(sort){tags=sortTags(tags)}return tags}function removeTag(tag,tags,sort){var value=$(tag).html();tags.assignedTags=removeTagFromList(value,tags.assignedTags);if(checkTag(value,tags.originalTags)){tags.availableTags.push(value)}$(tag).remove();if(sort){tags=sortTags(tags)}return tags}function sortTags(tags){tags.availableTags=tags.availableTags.sort();tags.assignedTags=tags.assignedTags.sort();tags.originalTags=tags.originalTags.sort();return tags}function saveTags(tags,opts,tcID){sendData={tags:tags.assignedTags};$.extend(sendData,opts.updateData);$.ajax({type:'POST',url:opts.updateURL,cache:false,data:sendData,dataType:'json',beforeSend:function(){if($("#"+tcID+"_save").length){$("#"+tcID+"_save").fadeOut(200,function(){$("#"+tcID+"_loader").fadeIn(200)})}else{$("#"+tcID+"_loader").fadeIn(200)}},complete:function(){$("#"+tcID+"_loader").fadeOut(200,function(){if($("#"+tcID+"_save").length){$("#"+tcID+"_save").fadeIn(200)}})}})}function addAssignedTags(opts,tags,inputField,tagContainer){$(tags.assignedTags).each(function(i,e){if(opts.allowEdit){$("<li />").addClass("tagItem").html(e).insertBefore($(inputField).parent())}else{$("<li />").addClass("tagItem").css("cursor","default").html(e).appendTo(tagContainerObject)}tags.availableTags=removeTagFromList(e,tags.availableTags)});return tags}function debug(tagContainer,options){if(options.debug&&window.console&&window.console.log){window.console.log(tagContainer);window.console.log(options);window.console.log($.fn.tagHandler.defaults)}}})(jQuery);